angular.module("MassAutoComplete",[]).directive("massAutocomplete",["$timeout","$window","$document","$q",function(e,t,n,o){"use strict";return{restrict:"A",scope:{options:"&massAutocomplete"},transclude:!0,template:'<span ng-transclude></span><div class="autocomplete suggestion" type="text" ng-bind="selection" /><div class="ac-container" ng-show="show_autocomplete && results.length > 0" style="position:absolute;"><ul class="ac-menu"><li ng-repeat="result in results" ng-if="$index > 0" class="ac-menu-item" ng-class="$index == selected_index ? \'ac-state-focus\': \'\'"><a href ng-click="apply_selection($index)" ng-bind-html="result.label"></a></li></ul></div>',link:function(e,t){e.container=angular.element(t[0].getElementsByClassName("ac-container")[0])},controller:["$scope",function(l){function s(e,t,n){var o;return function(){var l=this,s=arguments,a=function(){o=null,n||e.apply(l,s)},c=n&&!o;clearTimeout(o),o=setTimeout(a,t),c&&e.apply(l,s)}}function a(){if(p){var e=angular.element(p[0]),t=e.position(),n=angular.element(l.container[0]);n.css("top",t.top+e.outerHeight());var o=t.left,s=h.offset_width?h.offset_width(e):0;n.css("left",o+s)}}function c(e,t,o){p!==t&&(p&&v.detach(),t[0]===n[0].activeElement&&(o.on_attach&&o.on_attach(),p=t,_=e,h=o,m=e.$viewValue,l.results=[],l.selected_index=-1,d(),g=l.$watch(function(){return e.$modelValue},function(e,t){E(e,p,t),x()})))}function i(e,t,n){l.selected_index=0,l.waiting_for_suggestion=!0,"string"==typeof e&&e.length>=0?o.when(h.suggest(e),function(o){p&&p===t&&(o&&o.length>0?(1===o.length&&o[0].value===e?(l.results=o,r(0)):l.results=[{value:e,label:""}].concat(o),l.selection=e.length>0&&o.length>0?o[0].value:e,l.show_autocomplete=l.selection===e&&(e.length>0||0===e.length&&n.length>0)?!1:!0,h.auto_select_first&&r(1)):l.results=[])},function(e){l.show_autocomplete=!1,h.on_error&&h.on_error(e)}).finally(function(){l.waiting_for_suggestion=!1,0===l.results.length&&(l.selection=e)}):(l.waiting_for_suggestion=!1,l.show_autocomplete=!1,l.selection="",l.$apply())}function u(e){_.$modelValue!==e&&(_.$setViewValue(e),_.$render())}function r(e){var t=l.results[e];return p.attr("contenteditable")?p.html(t.value):p.val(t.value),l.selected_index=e,e>0&&(l.selection=t.value,p[0].selectionStart=l.results[0].value.length,p[0].selectionEnd=t.value.length),t}function d(){angular.element(t).bind(w.RESIZE,x),p.bind(w.BLUR,function(){e(function(){p&&p[0]===n[0].activeElement||v.detach()},y.debounce_blur)}),p.bind(w.KEYDOWN,function(e){if(!e.shiftKey)switch(e.keyCode){case b.ESC:l.show_autocomplete?(l.show_autocomplete=!1,l.$apply()):p.attr("contenteditable")?p.html(m):p.val(m);break;case b.ENTER:l.show_autocomplete&&l.selected_index>0&&!l.waiting_for_suggestion&&(l.apply_selection(l.selected_index),e.stopPropagation(),e.preventDefault()),l.show_autocomplete=!1,l.$apply();break;case b.TAB:if(!l.show_autocomplete)break;e.preventDefault();case b.DOWN:l.results.length>0?(l.show_autocomplete?(e.preventDefault(),r(l.selected_index+1>l.results.length-1?0:l.selected_index+1)):(l.show_autocomplete=!0,l.selected_index=0),l.$apply()):p.attr("contenteditable")?E(p.html(),p):E(p.val(),p);break;case b.UP:l.show_autocomplete&&(e.preventDefault(),r(l.selected_index-1>=0?l.selected_index-1:l.results.length-1),l.$apply());break;case b.RIGHT:l.show_autocomplete&&(l.selected_index<=0&&(l.selected_index=1),l.waiting_for_suggestion||(l.apply_selection(l.selected_index),e.stopPropagation(),e.preventDefault(),l.show_autocomplete=!1),l.$apply())}})}var p,_,h,m,g,f,v=this,b={TAB:9,ESC:27,ENTER:13,UP:38,RIGHT:39,DOWN:40},w={KEYDOWN:"keydown",RESIZE:"resize",BLUR:"blur"},$=l.options()||{},y={debounce_position:$.debounce_position||150,debounce_attach:$.debounce_attach||300,debounce_suggest:$.debounce_suggest||200,debounce_blur:$.debounce_blur||150};l.selection="",l.show_autocomplete=!1;var x=s(a,y.debounce_position);v.attach=s(c,y.debounce_attach);var E=s(i,y.debounce_suggest);v.detach=function(){if(p){var e=p.attr("contenteditable")?p.html():p.val();u(e),h.on_detach&&h.on_detach(e),p.unbind(w.KEYDOWN),p.unbind(w.BLUR)}l.show_autocomplete=!1,angular.element(t).unbind(w.RESIZE),g&&g(),l.selected_index=l.results=void 0,_=p=m=void 0},l.apply_selection=function(e){if(p[0].focus(),!(!l.show_autocomplete||e>l.results.length||0>e)){var t=r(e);f=t.value,u(t.value),l.show_autocomplete=!1,l.selection=t.value,h.on_select&&h.on_select(t)}},l.$on("$destroy",function(){v.detach(),l.container.remove()})}]}}]).directive("massAutocompleteItem",function(){"use strict";return{restrict:"A",require:["^massAutocomplete","ngModel"],scope:{massAutocompleteItem:"&"},link:function(e,t,n,o){n.$set("autocomplete","off"),t.bind("focus",function(){var n=e.massAutocompleteItem();if(!n)throw"Invalid options";o[0].attach(o[1],t,n)})}}});