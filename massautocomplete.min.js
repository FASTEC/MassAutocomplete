angular.module("MassAutoComplete",[]).directive("massAutocomplete",["$timeout","$window","$document","$q",function(e,t,n,o){"use strict";return{restrict:"A",scope:{options:"&massAutocomplete"},transclude:!0,template:'<span ng-transclude></span><div class="mass-autocomplete background" type="text" ng-bind="selection" /><div class="ac-container" ng-show="show_autocomplete && results.length > 0" style="position:absolute;"><ul class="ac-menu"><li ng-repeat="result in results" ng-if="$index > 0" class="ac-menu-item" ng-class="$index == selected_index ? \'ac-state-focus\': \'\'"><a href ng-click="apply_selection($index)" ng-bind-html="result.label"></a></li></ul></div>',link:function(e,t){e.container=angular.element(t[0].getElementsByClassName("ac-container")[0])},controller:["$scope",function(s){function l(e,t,n){var o;return function(){var s=this,l=arguments,a=function(){o=null,n||e.apply(s,l)},c=n&&!o;clearTimeout(o),o=setTimeout(a,t),c&&e.apply(s,l)}}function a(){var e=angular.element(p[0]),t=e.position(),n=angular.element(s.container[0]);n.css("top",t.top+e.outerHeight());var o=t.left,l=g.offset_width?g.offset_width(e):0;n.css("left",o+l)}function c(e,t,o){p!==t&&(p&&v.detach(),t[0]===n[0].activeElement&&(o.on_attach&&o.on_attach(),p=t,_=e,g=o,m=e.$viewValue,s.results=[],s.selected_index=-1,d(),h=s.$watch(function(){return e.$modelValue},function(e,t){E(e,p,t),x()})))}function i(e,t,n){s.selected_index=0,s.waiting_for_suggestion=!0,"string"==typeof e&&e.length>=0?o.when(g.suggest(e),function(o){p&&p===t&&(o&&o.length>0?(s.results=[{value:e,label:""}].concat(o),s.selection=e.length>0&&o.length>0?o[0].value:e,s.show_autocomplete=s.selection===e&&(e.length>0||0===e.length&&n.length>0)?!1:!0,g.auto_select_first&&r(1)):s.results=[])},function(e){s.show_autocomplete=!1,g.on_error&&g.on_error(e)}).finally(function(){s.waiting_for_suggestion=!1,0===s.results.length&&(s.selection=e)}):(s.waiting_for_suggestion=!1,s.show_autocomplete=!1,s.selection="",s.$apply())}function u(e){_.$modelValue!==e&&(_.$setViewValue(e),_.$render())}function r(e){var t=s.results[e];return p.val(t.value),s.selected_index=e,e>0&&(s.selection=t.value,p[0].selectionStart=s.results[0].value.length,p[0].selectionEnd=t.value.length),t}function d(){angular.element(t).bind(b.RESIZE,x),p.bind(b.BLUR,function(){e(function(){p&&p[0]===n[0].activeElement||v.detach()},y.debounce_blur)}),p.bind(b.KEYDOWN,function(e){if(!e.shiftKey)switch(e.keyCode){case w.ESC:s.show_autocomplete?(s.show_autocomplete=!1,s.$apply()):p.val(m);break;case w.ENTER:s.show_autocomplete&&s.selected_index>0&&!s.waiting_for_suggestion&&(s.apply_selection(s.selected_index),e.stopPropagation(),e.preventDefault()),s.show_autocomplete=!1,s.$apply();break;case w.TAB:if(!s.show_autocomplete)break;e.preventDefault();case w.DOWN:s.results.length>0?(s.show_autocomplete?(e.preventDefault(),r(s.selected_index+1>s.results.length-1?0:s.selected_index+1)):(s.show_autocomplete=!0,s.selected_index=0),s.$apply()):E(p.val(),p);break;case w.UP:s.show_autocomplete&&(e.preventDefault(),r(s.selected_index-1>=0?s.selected_index-1:s.results.length-1),s.$apply());break;case w.RIGHT:s.show_autocomplete&&(s.selected_index<=0&&(s.selected_index=1),s.waiting_for_suggestion||(s.apply_selection(s.selected_index),e.stopPropagation(),e.preventDefault(),s.show_autocomplete=!1),s.$apply())}})}var p,_,g,m,h,f,v=this,w={TAB:9,ESC:27,ENTER:13,UP:38,RIGHT:39,DOWN:40},b={KEYDOWN:"keydown",RESIZE:"resize",BLUR:"blur"},$=s.options()||{},y={debounce_position:$.debounce_position||150,debounce_attach:$.debounce_attach||300,debounce_suggest:$.debounce_suggest||200,debounce_blur:$.debounce_blur||150};s.selection="",s.show_autocomplete=!1;var x=l(a,y.debounce_position);v.attach=l(c,y.debounce_attach);var E=l(i,y.debounce_suggest);v.detach=function(){if(p){var e=p.val();u(e),g.on_detach&&g.on_detach(e),p.unbind(b.KEYDOWN),p.unbind(b.BLUR)}s.show_autocomplete=!1,angular.element(t).unbind(b.RESIZE),h&&h(),s.selected_index=s.results=void 0,_=p=m=void 0},s.apply_selection=function(e){if(p[0].focus(),!(!s.show_autocomplete||e>s.results.length||0>e)){var t=r(e);f=t.value,u(t.value),s.show_autocomplete=!1,s.selection="",g.on_select&&g.on_select(t)}},s.$on("$destroy",function(){v.detach(),s.container.remove()})}]}}]).directive("massAutocompleteItem",function(){"use strict";return{restrict:"A",require:["^massAutocomplete","ngModel"],scope:{massAutocompleteItem:"&"},link:function(e,t,n,o){n.$set("autocomplete","off"),t.bind("focus",function(){var n=e.massAutocompleteItem();if(!n)throw"Invalid options";o[0].attach(o[1],t,n)})}}});